#!/bin/bash

# convert-md - Convert Markdown files to HTML/PDF with Mermaid support
# Can be run from anywhere

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Print usage information
usage() {
    echo "Usage: convert-md [OPTIONS] <format> [input.md] [output]"
    echo ""
    echo "Convert Markdown files to HTML and/or PDF with Mermaid diagram support."
    echo ""
    echo "Formats:"
    echo "  html              Convert to HTML only"
    echo "  pdf               Convert to PDF only"
    echo "  both              Convert to both HTML and PDF"
    echo ""
    echo "Options:"
    echo "  -h, --help        Show this help message"
    echo "  -i, --init        Initialize dependencies (run npm install)"
    echo "  -v, --version     Show version"
    echo ""
    echo "Examples:"
    echo "  convert-md html README.md"
    echo "  convert-md pdf docs/guide.md output/guide.pdf"
    echo "  convert-md both README.md"
    echo "  convert-md --init          # Install dependencies first"
    echo ""
    echo "If no input file is specified, defaults to CODE_SUMMARY.md"
}

# Check if node_modules exists
check_dependencies() {
    if [ ! -d "$PROJECT_DIR/node_modules" ]; then
        echo -e "${YELLOW}⚠️  Dependencies not installed.${NC}"
        echo ""
        echo "Run one of the following to install:"
        echo "  convert-md --init"
        echo "  cd $PROJECT_DIR && npm install"
        echo ""
        return 1
    fi
    return 0
}

# Install dependencies
init_dependencies() {
    echo -e "${GREEN}Installing dependencies...${NC}"
    cd "$PROJECT_DIR" && npm install
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ Dependencies installed successfully${NC}"
    else
        echo -e "${RED}✗ Failed to install dependencies${NC}"
        exit 1
    fi
}

# Show version
show_version() {
    VERSION=$(node -p "require('$PROJECT_DIR/package.json').version" 2>/dev/null || echo "unknown")
    echo "convert-md version $VERSION"
}

# Parse arguments
if [ $# -eq 0 ]; then
    usage
    exit 0
fi

case "$1" in
    -h|--help)
        usage
        exit 0
        ;;
    -v|--version)
        show_version
        exit 0
        ;;
    -i|--init)
        init_dependencies
        exit 0
        ;;
    html|pdf|both)
        FORMAT="$1"
        shift
        ;;
    *)
        echo -e "${RED}Error: Unknown format or option '$1'${NC}"
        echo ""
        usage
        exit 1
        ;;
esac

# Check dependencies before running conversion
if ! check_dependencies; then
    exit 1
fi

# Save current working directory for output
WORKING_DIR="$(pwd)"

# Get input file (use absolute path if relative)
INPUT_FILE="${1:-}"
if [ -n "$INPUT_FILE" ] && [ ! "${INPUT_FILE:0:1}" = "/" ]; then
    INPUT_FILE="$WORKING_DIR/$INPUT_FILE"
fi

# Get output file if provided, or generate default in current directory
OUTPUT_FILE="${2:-}"
if [ -n "$OUTPUT_FILE" ]; then
    # User specified output - make absolute if relative
    if [ ! "${OUTPUT_FILE:0:1}" = "/" ]; then
        OUTPUT_FILE="$WORKING_DIR/$OUTPUT_FILE"
    fi
elif [ -n "$INPUT_FILE" ]; then
    # No output specified - generate in current working directory
    BASENAME=$(basename "$INPUT_FILE" .md)
    OUTPUT_FILE="$WORKING_DIR/$BASENAME"
    # Add extension based on format (will be handled by node script)
fi

# Run the conversion
cd "$PROJECT_DIR"
if [ -n "$OUTPUT_FILE" ] && [ -n "$INPUT_FILE" ]; then
    if [ "$FORMAT" = "both" ]; then
        node scripts/convert-markdown.js html "$INPUT_FILE" "${OUTPUT_FILE}.html"
        node scripts/convert-markdown.js pdf "$INPUT_FILE" "${OUTPUT_FILE}.pdf"
    elif [ "$FORMAT" = "html" ]; then
        # Add .html extension if not present
        if [[ "$OUTPUT_FILE" != *.html ]]; then
            OUTPUT_FILE="${OUTPUT_FILE}.html"
        fi
        node scripts/convert-markdown.js "$FORMAT" "$INPUT_FILE" "$OUTPUT_FILE"
    elif [ "$FORMAT" = "pdf" ]; then
        # Add .pdf extension if not present
        if [[ "$OUTPUT_FILE" != *.pdf ]]; then
            OUTPUT_FILE="${OUTPUT_FILE}.pdf"
        fi
        node scripts/convert-markdown.js "$FORMAT" "$INPUT_FILE" "$OUTPUT_FILE"
    fi
elif [ -n "$INPUT_FILE" ]; then
    node scripts/convert-markdown.js "$FORMAT" "$INPUT_FILE"
else
    node scripts/convert-markdown.js "$FORMAT"
fi
